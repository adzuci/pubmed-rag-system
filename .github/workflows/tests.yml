name: Lint and validate

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt -r ui/requirements.txt

      - name: Run pre-commit checks (includes black)
        run: make precommit-run

      - name: Run tests with coverage
        shell: bash
        run: |
          set -o pipefail
          make coverage | tee coverage.txt

      - name: Comment tests/coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const marker = '<!-- coverage-report -->';
            const output = fs.readFileSync('coverage.txt', 'utf8');
            const lines = output.split('\n');

            const summaryLine = lines.find((line) => /passed in/.test(line)) || '';
            let start = lines.findIndex((line) => line.includes('tests coverage'));
            if (start === -1) {
              start = lines.findIndex((line) => line.startsWith('Name'));
            }
            const snippet = (start >= 0 ? lines.slice(start) : lines)
              .slice(0, 80)
              .join('\n')
              .trim();

            const body = [
              marker,
              '## Tests and coverage',
              summaryLine ? `**${summaryLine}**` : '',
              '```',
              snippet || 'Coverage output not found.',
              '```',
            ]
              .filter(Boolean)
              .join('\n\n');

            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;

            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
            });

            const existing = comments.data.find((comment) =>
              comment.body && comment.body.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body,
              });
            }

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform validate
        run: |
          terraform -chdir=terraform init -backend=false
          # Patch bedrock module for provider changes:
          # 1) data.aws_region.current.region -> data.aws_region.current.name
          #    (aws_region data source now exposes "name" not "region")
          find terraform/.terraform/modules/bedrock -name "*.tf" -type f -exec sed -i 's/data\.aws_region\.current\.region/data.aws_region.current.name/g' {} \;
          # Fix bedrock module bug: local.name is undefined in version 0.0.33
          # The module uses local.name for region in ARNs but doesn't define it
          # Replace with var.aws_region (passed to module) or add local definition
          # First, try to add local.name to locals block if it exists
          if [ -f terraform/.terraform/modules/bedrock/locals.tf ]; then
            # Check if name is already defined
            if ! grep -qE '^\s*name\s*=' terraform/.terraform/modules/bedrock/locals.tf; then
              # Add name = var.aws_region after first locals { line
              sed -i '/^locals {/a\  name = var.aws_region' terraform/.terraform/modules/bedrock/locals.tf
            fi
          fi
          # Also replace direct references as fallback
          find terraform/.terraform/modules/bedrock -name "*.tf" -type f -exec sed -i 's/\${local\.name}/\${var.aws_region}/g' {} \;
          find terraform/.terraform/modules/bedrock -name "*.tf" -type f -exec sed -i 's/local\.name/var.aws_region/g' {} \;
          terraform -chdir=terraform validate
